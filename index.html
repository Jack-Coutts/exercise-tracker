<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exercise Tracker</title>
    <style>
        /* CORE STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Courier New', Monaco, monospace; background: white; color: black; padding: 20px; line-height: 1.6; font-size: 12px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; }
        h1 { text-align: center; margin-bottom: 20px; font-weight: normal; color: black; }
        .section { margin-bottom: 30px; }
        .section-title { margin-bottom: 15px; text-decoration: underline; }
        .input-row { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center; }
        
        input, select, textarea, button { 
            font-family: 'Courier New', Monaco, monospace; 
            border: 1px solid black; padding: 4px; font-size: 12px; 
            color: black; background: white; border-radius: 0; appearance: none;
        }
        
        textarea { width: 100%; min-height: 40px; resize: vertical; margin-top: 5px; }
        button { cursor: pointer; transition: background 0.2s; }
        button:hover { background: #f0f0f0; }

        /* LOG LIST STYLES */
        .exercise-list { margin-top: 15px; border: 1px solid black; padding: 10px; min-height: 200px; }
        .exercise-entry { margin-bottom: 15px; border-bottom: 1px dotted black; padding-bottom: 12px; display: flex; flex-direction: column; }
        .exercise-text { font-family: 'Courier New', Monaco, monospace; white-space: pre-wrap; color: black; word-break: break-word; }
        .exercise-notes { margin-left: 20px; font-style: italic; color: #555; margin-bottom: 5px; white-space: pre-wrap; word-break: break-word; }
        
        .delete-btn { 
            padding: 2px 8px; font-size: 9px; margin-top: 8px; 
            align-self: flex-start; width: auto; color: black; border: 1px solid black;
        }

        /* SUMMARY STYLES - FIXED FOR MOBILE OVERFLOW */
        .summary { border: 2px solid black; padding: 15px; margin-top: 30px; overflow-x: hidden; }
        .summary-group { margin-bottom: 25px; }
        .summary-subtitle { font-weight: bold; margin-bottom: 10px; text-decoration: underline; font-size: 13px; }
        .summary-total-line { margin-bottom: 8px; font-weight: normal; }
        
        /* Flexbox for dashed lines prevents spillover */
        .summary-line { 
            display: flex; 
            align-items: baseline; 
            margin-bottom: 3px; 
            font-size: 11px; 
            width: 100%;
            overflow: hidden;
        }
        .summary-label { flex-shrink: 0; white-space: nowrap; }
        .summary-dash { 
            flex-grow: 1; 
            border-bottom: 1px dotted black; 
            margin: 0 5px; 
            position: relative;
            top: -4px; /* Aligns dots with text middle */
        }
        .summary-stats { flex-shrink: 0; white-space: nowrap; text-align: right; }

        /* HEATMAP */
        .heatmap-container { margin-top: 20px; width: 100%; }
        .heatmap-year-label { font-weight: bold; margin-top: 15px; margin-bottom: 5px; text-decoration: underline; }
        .heatmap-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; border: 1px solid #eee; padding: 5px; margin-bottom: 15px; }
        .heatmap-grid { display: grid; grid-template-columns: repeat(31, 1fr); gap: 2px; min-width: 450px; }
        .heatmap-cell { width: 10px; height: 10px; border-radius: 2px; border: 1px solid #e5e7eb; }
        .level-0 { background-color: #ffffff; }
        .level-1 { background-color: #d1d5db; }
        .level-2 { background-color: #9ca3af; }
        .level-3 { background-color: #6b7280; }
        .level-4 { background-color: #000000; }

        .exercise-type-manager { margin-bottom: 15px; border: 1px solid black; padding: 10px; }
        .exercise-type-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; padding: 2px 5px; border-bottom: 1px solid #eee; }
        .type-del-btn { padding: 1px 4px; font-size: 9px; margin-left: 15px; }

        .drop-zone { border: 2px dashed black; padding: 40px; text-align: center; margin-bottom: 10px; background: #f9f9f9; cursor: pointer; font-weight: bold; }
        .hidden { display: none !important; }

        /* MOBILE OVERRIDES */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .input-row { flex-direction: column; align-items: stretch; }
            input, select, .main-action-btn { width: 100%; height: 38px; margin-right: 0; }
            .summary-line { font-size: 10px; }
            .summary-label { max-width: 40%; overflow: hidden; text-overflow: ellipsis; }
        }

        /* PRINT SETTINGS */
        @media print {
            .drop-zone, .exercise-type-manager, .buttons, .section:has(.input-row), h1, .delete-btn, .type-del-btn { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .heatmap-wrapper { border: none; overflow: visible; }
            .heatmap-grid { min-width: auto; }
            .heatmap-cell { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exercise Tracker</h1>

        <div id="uploadPrompt" class="drop-zone">
            <div id="importTapTarget">TAP TO IMPORT EXERCISES.CSV</div>
            <div style="margin-top: 15px; font-weight: normal; border-top: 1px solid #ccc; padding-top: 10px;">
                <button id="startFreshBtn" class="main-action-btn">Or Start Fresh Session</button>
            </div>
        </div>

        <div id="mainApp" class="hidden">
            <div class="section">
                <h2 class="section-title">Add Exercise</h2>
                <div class="input-row">
                    <input type="date" id="exerciseDate">
                    <select id="exerciseTypeSelect"></select>
                    <input type="number" id="exerciseDuration" placeholder="Minutes">
                    <button id="addExerciseBtn" class="main-action-btn">Add</button>
                </div>
                <textarea id="exerciseNotes" placeholder="Notes (optional)"></textarea>
            </div>

            <div class="section">
                <h2 class="section-title">Exercise Types</h2>
                <div class="exercise-type-manager">
                    <div class="input-row">
                        <input type="text" id="newExerciseType" placeholder="New type...">
                        <button id="addTypeBtn" class="type-add-btn">Add Type</button>
                    </div>
                    <div id="exerciseTypeList"></div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Summary & History Heatmaps</h2>
                <div class="summary">
                    <div id="summaryContent"></div>
                    <div id="multiHeatmapContainer" class="heatmap-container"></div>
                    <div class="buttons">
                        <button id="printBtn">Print PDF</button>
                        <button id="exportBtn">Export CSV</button>
                        <button id="clearBtn">Clear Session</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Exercise Log</h2>
                <div class="exercise-list" id="exerciseList"></div>
            </div>
        </div>

        <input type="file" id="csvFileInput" accept=".csv" style="display:none">
    </div>

    <script>
        function clearElement(el) {
            while (el.firstChild) el.removeChild(el.firstChild);
        }

        function isValidISODateYYYYMMDD(s) {
            if (typeof s !== 'string') return false;
            if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
            const d = new Date(s + 'T00:00:00Z');
            return Number.isFinite(d.getTime()) && d.toISOString().slice(0, 10) === s;
        }

        // RFC4180-ish CSV parser:
        // - Supports commas/newlines inside quoted fields
        // - Supports escaped quotes as ""
        // Returns array of rows; each row is array of fields (strings).
        function parseCSV(text) {
            const rows = [];
            let row = [];
            let field = '';
            let inQuotes = false;

            // Normalize line endings to \n (keep actual \n as row breaks only when not in quotes)
            const s = String(text || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');

            for (let i = 0; i < s.length; i++) {
                const ch = s[i];

                if (inQuotes) {
                    if (ch === '"') {
                        const next = s[i + 1];
                        if (next === '"') { // escaped quote
                            field += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        field += ch;
                    }
                } else {
                    if (ch === '"') {
                        inQuotes = true;
                    } else if (ch === ',') {
                        row.push(field);
                        field = '';
                    } else if (ch === '\n') {
                        row.push(field);
                        field = '';
                        rows.push(row);
                        row = [];
                    } else {
                        field += ch;
                    }
                }
            }

            // flush last field/row
            row.push(field);
            rows.push(row);

            // trim possible trailing empty rows (common if file ends with newline)
            while (rows.length > 0) {
                const last = rows[rows.length - 1];
                const allEmpty = last.every(v => String(v).trim() === '');
                if (!allEmpty) break;
                rows.pop();
            }

            return rows;
        }

        class ExerciseTracker {
            constructor() {
                this.exercises = [];
                this.exerciseTypes = ['cycling', 'gym', 'squash', 'running', 'pilates', 'swimming'];

                this.bindUI();
                this.setDefaultDate();
                this.updateDisplay(); // ensures type select has initial options
            }

            bindUI() {
                const importTapTarget = document.getElementById('importTapTarget');
                const csvInput = document.getElementById('csvFileInput');

                importTapTarget.addEventListener('click', () => csvInput.click());
                document.getElementById('startFreshBtn').addEventListener('click', () => this.startFresh());

                document.getElementById('addExerciseBtn').addEventListener('click', () => this.addExercise());
                document.getElementById('addTypeBtn').addEventListener('click', () => this.addExerciseType());

                document.getElementById('printBtn').addEventListener('click', () => window.print());
                document.getElementById('exportBtn').addEventListener('click', () => this.exportToCSV());
                document.getElementById('clearBtn').addEventListener('click', () => location.reload());

                csvInput.addEventListener('change', (e) => handleFileImport(e));
            }

            setDefaultDate() {
                const el = document.getElementById('exerciseDate');
                el.value = new Date().toISOString().split('T')[0];
            }

            startFresh() {
                document.getElementById('uploadPrompt').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                this.updateDisplay();
            }

            addExercise() {
                const date = document.getElementById('exerciseDate').value;
                const type = document.getElementById('exerciseTypeSelect').value;
                const durationRaw = document.getElementById('exerciseDuration').value;
                const duration = parseInt(durationRaw, 10);
                const notes = document.getElementById('exerciseNotes').value.trim();

                if (!date || !type || !Number.isFinite(duration) || duration <= 0) {
                    return alert('Fill required fields');
                }

                this.exercises.unshift({
                    id: Date.now(),
                    date,
                    exercise_type: type,
                    duration_minutes: duration,
                    notes
                });

                this.updateDisplay();
                document.getElementById('exerciseDuration').value = '';
                document.getElementById('exerciseNotes').value = '';
            }

            addExerciseType() {
                const val = document.getElementById('newExerciseType').value.trim().toLowerCase();
                if (val && !this.exerciseTypes.includes(val)) {
                    this.exerciseTypes.push(val);
                    this.updateDisplay();
                    document.getElementById('newExerciseType').value = '';
                }
            }

            deleteExerciseType(type) {
                if (this.exercises.some(ex => ex.exercise_type === type)) return alert('In use');
                this.exerciseTypes = this.exerciseTypes.filter(t => t !== type);
                this.updateDisplay();
            }

            deleteExercise(id) {
                if (confirm('Delete?')) {
                    this.exercises = this.exercises.filter(ex => ex.id !== id);
                    this.updateDisplay();
                }
            }

            formatExerciseLine(date, type, duration) {
                const fmtDate = new Date(date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                return `${fmtDate} ${type} â€” ${duration} min`;
            }

            updateDisplay() {
                this.updateTypeUI();
                this.updateLogUI();
                this.updateSummaryUI();
            }

            updateTypeUI() {
                const sel = document.getElementById('exerciseTypeSelect');
                const cur = sel.value;

                clearElement(sel);

                const defaultOpt = document.createElement('option');
                defaultOpt.value = '';
                defaultOpt.textContent = 'Select...';
                sel.appendChild(defaultOpt);

                const sortedTypes = [...this.exerciseTypes].sort((a, b) => a.localeCompare(b));
                for (const t of sortedTypes) {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    sel.appendChild(opt);
                }

                if (this.exerciseTypes.includes(cur)) sel.value = cur;

                const list = document.getElementById('exerciseTypeList');
                clearElement(list);

                for (const t of sortedTypes) {
                    const item = document.createElement('div');
                    item.className = 'exercise-type-item';

                    const span = document.createElement('span');
                    span.textContent = t;

                    const btn = document.createElement('button');
                    btn.className = 'type-del-btn';
                    btn.type = 'button';
                    btn.textContent = 'DEL';
                    btn.addEventListener('click', () => this.deleteExerciseType(t));

                    item.appendChild(span);
                    item.appendChild(btn);
                    list.appendChild(item);
                }
            }

            updateLogUI() {
                const sorted = [...this.exercises].sort((a, b) => new Date(b.date) - new Date(a.date));
                const list = document.getElementById('exerciseList');
                clearElement(list);

                if (sorted.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'no-exercises';
                    empty.textContent = 'Empty session.';
                    list.appendChild(empty);
                    return;
                }

                for (const ex of sorted) {
                    const entry = document.createElement('div');
                    entry.className = 'exercise-entry';

                    const text = document.createElement('div');
                    text.className = 'exercise-text';
                    text.textContent = this.formatExerciseLine(ex.date, ex.exercise_type, ex.duration_minutes);

                    entry.appendChild(text);

                    if (ex.notes) {
                        const notes = document.createElement('div');
                        notes.className = 'exercise-notes';
                        notes.textContent = ex.notes;
                        entry.appendChild(notes);
                    }

                    const del = document.createElement('button');
                    del.className = 'delete-btn';
                    del.type = 'button';
                    del.textContent = 'DELETE';
                    del.addEventListener('click', () => this.deleteExercise(ex.id));

                    entry.appendChild(del);
                    list.appendChild(entry);
                }
            }

            updateSummaryUI() {
                const now = new Date();
                const thirtyDaysAgo = new Date(now);
                thirtyDaysAgo.setDate(now.getDate() - 30);

                const ninetyDaysAgo = new Date(now);
                ninetyDaysAgo.setDate(now.getDate() - 90);

                let startDateText = "";
                if (this.exercises.length > 0) {
                    const sortedAsc = [...this.exercises].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const firstDate = new Date(sortedAsc[0].date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    startDateText = ` (since ${firstDate})`;
                }

                const stats = {
                    last30: this.calculateGroupStats(this.exercises.filter(ex => new Date(ex.date) >= thirtyDaysAgo)),
                    last90: this.calculateGroupStats(this.exercises.filter(ex => new Date(ex.date) >= ninetyDaysAgo)),
                    allData: this.calculateGroupStats(this.exercises)
                };

                const summaryContent = document.getElementById('summaryContent');
                clearElement(summaryContent);

                summaryContent.appendChild(this.renderSummarySection("Last 30 Days", stats.last30));
                summaryContent.appendChild(this.renderSummarySection("Last 90 Days", stats.last90));
                summaryContent.appendChild(this.renderSummarySection(`All Data Summary${startDateText}`, stats.allData));

                this.renderHeatmaps();
            }

            calculateGroupStats(exercises) {
                const group = exercises.reduce((acc, ex) => {
                    if (!acc[ex.exercise_type]) acc[ex.exercise_type] = { count: 0, min: 0 };
                    acc[ex.exercise_type].count++;
                    acc[ex.exercise_type].min += ex.duration_minutes;
                    return acc;
                }, {});

                const totalMins = exercises.reduce((sum, ex) => sum + ex.duration_minutes, 0);
                const typeCount = Object.keys(group).length;

                return { breakdown: group, totalMins, typeCount };
            }

            renderSummarySection(title, data) {
                const groupEl = document.createElement('div');
                groupEl.className = 'summary-group';

                const subtitle = document.createElement('div');
                subtitle.className = 'summary-subtitle';
                subtitle.textContent = title;

                const total = document.createElement('div');
                total.className = 'summary-total-line';
                total.textContent = `Total exercises: ${data.typeCount} types, ${data.totalMins} minutes`;

                groupEl.appendChild(subtitle);
                groupEl.appendChild(total);

                const sortedTypes = Object.entries(data.breakdown).sort((a, b) => b[1].min - a[1].min);

                if (sortedTypes.length === 0) {
                    const noData = document.createElement('div');
                    noData.className = 'summary-line';
                    noData.textContent = 'No data for this period.';
                    groupEl.appendChild(noData);
                    return groupEl;
                }

                for (const [type, d] of sortedTypes) {
                    const line = document.createElement('div');
                    line.className = 'summary-line';

                    const label = document.createElement('span');
                    label.className = 'summary-label';
                    label.textContent = type;

                    const dash = document.createElement('span');
                    dash.className = 'summary-dash';

                    const stats = document.createElement('span');
                    stats.className = 'summary-stats';
                    stats.textContent = `${d.count} sessions, ${d.min} min`;

                    line.appendChild(label);
                    line.appendChild(dash);
                    line.appendChild(stats);

                    groupEl.appendChild(line);
                }

                return groupEl;
            }

            renderHeatmaps() {
                const container = document.getElementById('multiHeatmapContainer');
                clearElement(container);

                const years = [...new Set(this.exercises.map(ex => new Date(ex.date).getFullYear()))].sort((a, b) => b - a);
                if (years.length === 0) years.push(new Date().getFullYear());

                years.forEach(year => {
                    const label = document.createElement('div');
                    label.className = 'heatmap-year-label';
                    label.innerText = `Year: ${year}`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'heatmap-wrapper';

                    const grid = document.createElement('div');
                    grid.className = 'heatmap-grid';

                    // Safe: generated cells use computed dates/minutes (not raw user strings)
                    grid.innerHTML = this.generateYearGrid(year);

                    wrapper.appendChild(grid);
                    container.appendChild(label);
                    container.appendChild(wrapper);
                });
            }

            generateYearGrid(year) {
                const daily = this.exercises.reduce((acc, ex) => {
                    acc[ex.date] = (acc[ex.date] || 0) + ex.duration_minutes;
                    return acc;
                }, {});

                let html = '';
                for (let m = 0; m < 12; m++) {
                    for (let d = 1; d <= 31; d++) {
                        const dt = new Date(year, m, d);
                        if (dt.getMonth() !== m) { html += '<div class="heatmap-cell level-0"></div>'; continue; }
                        const str = `${year}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                        const mins = daily[str] || 0;
                        const lvl = mins === 0 ? 0 : mins <= 30 ? 1 : mins <= 60 ? 2 : mins <= 120 ? 3 : 4;
                        html += `<div class="heatmap-cell level-${lvl}" title="${str}: ${mins}min"></div>`;
                    }
                }
                return html;
            }

            importCSV(csvText) {
                const rows = parseCSV(csvText);
                if (!rows || rows.length < 2) return;

                const headers = rows[0].map(h => String(h || '').trim().toLowerCase());
                const idxDate = headers.indexOf('date');
                const idxType = headers.indexOf('exercise_type');
                const idxDur = headers.indexOf('duration_minutes');
                const idxNotes = headers.indexOf('notes');

                if (idxDate === -1 || idxType === -1 || idxDur === -1) {
                    alert('CSV must include headers: date, exercise_type, duration_minutes (notes optional).');
                    return;
                }

                const imported = [];
                for (let i = 1; i < rows.length; i++) {
                    const r = rows[i] || [];
                    const dateRaw = String(r[idxDate] ?? '').trim();
                    const typeRaw = String(r[idxType] ?? '').trim();
                    const durRaw = String(r[idxDur] ?? '').trim();
                    const notesRaw = String(r[idxNotes] ?? '').trim();

                    // Keep behavior for valid data; just avoid invalids poisoning stats/UI.
                    if (!isValidISODateYYYYMMDD(dateRaw)) continue;
                    if (!typeRaw) continue;

                    const dur = parseInt(durRaw, 10);
                    const duration = Number.isFinite(dur) && dur > 0 ? dur : 0;

                    if (typeRaw && !this.exerciseTypes.includes(typeRaw)) this.exerciseTypes.push(typeRaw);

                    imported.push({
                        id: Date.now() + Math.random(),
                        date: dateRaw,
                        exercise_type: typeRaw,
                        duration_minutes: duration,
                        notes: notesRaw
                    });
                }

                this.exercises = imported;
                this.startFresh();
            }

            exportToCSV() {
                const h = 'date,exercise_type,duration_minutes,notes';
                const r = this.exercises.map(ex => {
                    const notes = String(ex.notes || '').replace(/"/g, '""');
                    return `${ex.date},${ex.exercise_type},${ex.duration_minutes},"${notes}"`;
                });
                const csvContent = [h, ...r].join('\n');
                const blob = new Blob([csvContent], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `workout_history_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
        }

        const tracker = new ExerciseTracker();

        function handleFileImport(e) {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => tracker.importCSV(evt.target.result);
            reader.readAsText(file);
        }
    </script>
</body>
</html>
